<html>
{% load static %}
<head>
	<meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<title>Kakao 지도 시작하기</title>
    <link rel="stylesheet" href="static/MapApp/css/index.css">
</head>
<body>
    <div id="mapwrap">
        <div id="map" style="width:450px;height:600px;">
            <div class="category">
                <ul>
                    <li id="cafeMenu" onclick="changeCafe()">
                        <span class="cafe-btn"></span>
                        카페
                    </li>
                    <li id="loungeMenu" onclick="test()">
                        <span class="ico_com ico_lounge_image"></span>
                        <span class="ico_comm ico_lounge"></span>
                        라운지
                    </li>
                    <li id="bookMenu" onclick="changeMarker('book')">
                        <span class="ico_com ico_book_image"></span>
                        <span class="ico_comm ico_book"></span>
                        책반납기
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <h1 id="test"> 랄루 </h1>
    <!-- 지도 위에 표시될 마커 카테고리 -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=	19de326d13f32aab18ce3a0096074178"></script>
	<script>
		/* 지도 생성 */
		var mapContainer = document.getElementById('map');
		var mapOption = {
			center: new kakao.maps.LatLng(37.58631, 127.02936),
			level: 4
		}
		var map = new kakao.maps.Map(mapContainer, mapOption);

		/* DB 정보 저장 */
		const buildings = "{{buildings}}";
		const temp1 = JSON.parse(buildings.replace(/&quot;/g,"\""));
    
		// view에서 받아온 DB담아두기 
        categoryPositions = []

		/* Building 중심 >> 위도, 경도 좌표 저장 */
		const buildingLocations  = temp1.map(element => {return  {
			pk: element.pk,
        	latlng: new kakao.maps.LatLng(element.fields.building_lat, element.fields.building_lon),
          lat: element.fields.building_lat,
          long: element.fields.building_lon,
		  history: element.fields.history,
        }} );

        // 모든 건물 마커들의 좌푯값 담아두기
        let allPositions = []
        buildingLocations.forEach(function(item){
            allPositions.push(item['latlng'])
        })

        var imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png"; 
    
        for (var i = 0; i < allPositions.length; i ++) {
    
            // 마커 이미지의 이미지 크기 입니다
            var imageSize = new kakao.maps.Size(24, 35); 
            
            // 마커 이미지를 생성합니다    
            var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize); 
            
            // 마커를 생성합니다
            var marker = new kakao.maps.Marker({
                map: map, // 마커를 표시할 지도
                position: allPositions[i], // 마커를 표시할 위치
                image : markerImage // 마커 이미지 
            });
        }

        /* category 버튼 클릭 시 받아오는 마커 좌표값 비동기 구현 */
        const changeCafe = () => {
            fetch('/category', {
                method: "POST",
            })
            .then(response => response.json())
            .then(res => res['latlng'].forEach(function(item){
            categoryPositions.push(new kakao.maps.LatLng(item[0], item[1]))
        }))



     

        var imageSrc = "https://postfiles.pstatic.net/MjAyMjA4MDRfMTY1/MDAxNjU5NTQ1MzY1OTk3.FPkKlKkdyWb9MZ278pBlrNymusH_CGWPshTggNTzY10g.vt3gYVAhITm4Lk_md5yh74wWRQJrEn-qkKpUeBnoRl0g.PNG.ahrefhoo/coffeMarker.png?type=w966"; 

        for (var i = 0; i < categoryPositions.length; i ++) {
    
            // 마커 이미지의 이미지 크기 입니다
            var imageSize = new kakao.maps.Size(24, 35); 
            
            // 마커 이미지를 생성합니다    
            var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize); 
            
            // 마커를 생성합니다
            var marker = new kakao.maps.Marker({
                map: map, // 마커를 표시할 지도
                position: categoryPositions[i], // 마커를 표시할 위치
                image : markerImage // 마커 이미지 
            });
        }
            
        }
        


    </script>
	
</body>
</html>
